name: Build & Release

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.1.0)'
        required: true
        type: string
      create_release:
        description: 'Create a GitHub release'
        required: true
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APPLE_SIGNING_IDENTITY: "Developer ID Application: Minimal Audio Corporation (F56V2R36KY)"

jobs:
  build-mac:
    runs-on: macos-latest
    environment: ci
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Add macOS targets (universal binary)
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install frontend dependencies
        run: bun install

      # Import certificate into keychain (for CI runners)
      - name: Import signing certificate
        if: github.event_name != 'pull_request'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12

          # Create temporary keychain
          security create-keychain -p "build" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "build" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Add keychain to search list (critical for codesign to find the certificate)
          security list-keychains -d user -s build.keychain $(security list-keychains -d user | tr -d '"')

          # Import certificate
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productsign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "build" build.keychain

          # Verify certificate was imported correctly
          security find-identity -v build.keychain

          rm certificate.p12

      # Store notarytool credentials
      - name: Setup notarization credentials
        if: github.event_name != 'pull_request'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcrun notarytool store-credentials "notary-profile" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID"

      - name: Build frontend
        run: bun run build

      - name: Install Tauri CLI
        run: |
          curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
          cargo binstall tauri-cli --no-confirm

      - name: Build Tauri app (universal)
        run: cargo tauri build --target universal-apple-darwin

      - name: Sign app bundle
        if: github.event_name != 'pull_request'
        run: |
          APP_PATH="src-tauri/target/universal-apple-darwin/release/bundle/macos/Difference.app"

          # Remove extended attributes
          xattr -cr "$APP_PATH"

          # Sign with hardened runtime
          codesign --deep --strict --timestamp --options=runtime \
            -fs "${{ env.APPLE_SIGNING_IDENTITY }}" "$APP_PATH"

          # Verify
          codesign -dvv "$APP_PATH"

      - name: Create and sign DMG
        if: github.event_name != 'pull_request'
        run: |
          # Find the DMG file (name includes version)
          DMG_PATH=$(find src-tauri/target/universal-apple-darwin/release/bundle/dmg -name "*.dmg" | head -1)
          echo "Found DMG: $DMG_PATH"

          # Sign DMG
          codesign --timestamp -fs "${{ env.APPLE_SIGNING_IDENTITY }}" "$DMG_PATH"

      - name: Notarize DMG
        if: github.event_name != 'pull_request'
        run: |
          # Find the DMG file (name includes version)
          DMG_PATH=$(find src-tauri/target/universal-apple-darwin/release/bundle/dmg -name "*.dmg" | head -1)
          echo "Notarizing: $DMG_PATH"

          xcrun notarytool submit "$DMG_PATH" \
            --keychain-profile "notary-profile" \
            --wait -v

          xcrun stapler staple "$DMG_PATH"

      - name: Upload Mac artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg

  build-windows:
    runs-on: windows-latest
    environment: ci
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install frontend dependencies
        run: bun install

      - name: Build frontend
        run: bun run build

      - name: Install Tauri CLI
        run: |
          Set-ExecutionPolicy Unrestricted -Scope Process
          iex "& { $(irm https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.ps1) }"
          cargo binstall tauri-cli --no-confirm

      - name: Build Tauri app
        run: cargo tauri build

      # Azure Trusted Signing setup
      - name: Setup Azure Trusted Signing
        if: github.event_name != 'pull_request'
        shell: pwsh
        run: |
          # Download NuGet
          $nugetPath = "$env:RUNNER_TEMP\nuget.exe"
          Invoke-WebRequest -Uri "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe" -OutFile $nugetPath

          # Install Microsoft Trusted Signing Client
          & $nugetPath install Microsoft.Trusted.Signing.Client -OutputDirectory "$env:RUNNER_TEMP\signing"

          # Find the DLL
          $dllPath = Get-ChildItem -Path "$env:RUNNER_TEMP\signing" -Recurse -Filter "Azure.CodeSigning.Dlib.dll" |
                     Where-Object { $_.FullName -like "*x64*" } |
                     Select-Object -First 1 -ExpandProperty FullName

          echo "TRUSTED_SIGNING_DLL=$dllPath" >> $env:GITHUB_ENV

      - name: Sign Windows executables
        if: github.event_name != 'pull_request'
        shell: pwsh
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          # Create metadata JSON for Azure Trusted Signing
          $metadataJson = @{
            Endpoint = "https://eus.codesigning.azure.net/"
            CodeSigningAccountName = "${{ secrets.AZURE_CODESIGNING_ACCOUNT }}"
            CertificateProfileName = "${{ secrets.AZURE_CERT_PROFILE }}"
          } | ConvertTo-Json

          $metadataPath = "$env:RUNNER_TEMP\metadata.json"
          $metadataJson | Out-File -FilePath $metadataPath -Encoding utf8

          # Find signtool
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter "signtool.exe" |
                      Where-Object { $_.FullName -like "*x64*" } |
                      Sort-Object { [version]($_.Directory.Parent.Name) } -Descending |
                      Select-Object -First 1 -ExpandProperty FullName

          # Sign NSIS installer
          $nsisExe = Get-ChildItem -Path "src-tauri\target\release\bundle\nsis" -Filter "*.exe" | Select-Object -First 1
          if ($nsisExe) {
            & $signtool sign /v /debug /fd SHA256 /tr "http://timestamp.acs.microsoft.com" /td SHA256 `
              /dlib "$env:TRUSTED_SIGNING_DLL" /dmdf $metadataPath $nsisExe.FullName
          }

          # Sign MSI installer
          $msiFile = Get-ChildItem -Path "src-tauri\target\release\bundle\msi" -Filter "*.msi" | Select-Object -First 1
          if ($msiFile) {
            & $signtool sign /v /debug /fd SHA256 /tr "http://timestamp.acs.microsoft.com" /td SHA256 `
              /dlib "$env:TRUSTED_SIGNING_DLL" /dmdf $metadataPath $msiFile.FullName
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/msi/*.msi

  release:
    needs: [build-mac, build-windows]
    if: github.event_name == 'workflow_dispatch' && inputs.create_release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          draft: true
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.exe
            artifacts/**/*.msi
